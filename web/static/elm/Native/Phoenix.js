Elm.Native.Phoenix = {};
Elm.Native.Phoenix.make = function(localRuntime) {
  localRuntime.Native         = localRuntime.Native || {};
  localRuntime.Native.Phoenix = localRuntime.Native.Phoenix || {};

  if (localRuntime.Native.Phoenix.values) {
    return localRuntime.Native.Phoenix.values;
  }

  var Task   = Elm.Native.Task.make(localRuntime);
  var Signal = Elm.Native.Signal.make(localRuntime);

  var Socket = require("phoenix").Socket;

  function connect(url, options) {
    return Task.asyncFunction(function(callback){
      var socket = new Socket(url, options);

      socket.onOpen(function() {
        callback(Task.succeed(socket));
      })

      //TODO: handle connection failure. HOW DO?

      socket.connect();
    });
  }

  function join(socket, spec) {
    return Task.asyncFunction(function(callback){
      var channel = socket.channel(spec.name)

      //wat?
      var sub = spec.subscriptions._0
      console.log(sub, 1);

      // signals? ports? tasks? shrug
      channel.on(sub.event, function(payload) {
        localRuntime.ports[sub.portName].send(payload);
      });

      channel.join()
        .receive("ok", function(response) {
          callback(Task.succeed(channel));
        })
        .receive("error", function(reason) {
          callback(Task.fail(reason));
        })
    });
  }

  return localRuntime.Native.Phoenix.values = {
    connect: F2(connect),
    join:    F2(join)
  };
};

// Phoenix Client 1.0.3
(function(){"use strict";var globals=typeof window!=="undefined"?window:global;if(typeof globals.require==="function")return;var modules={};var cache={};var has=function(object,name){return{}.hasOwnProperty.call(object,name)};var expand=function(root,name){var results=[],parts,part;if(/^\.\.?(\/|$)/.test(name)){parts=[root,name].join("/").split("/")}else{parts=name.split("/")}for(var i=0,length=parts.length;i<length;i++){part=parts[i];if(part===".."){results.pop()}else if(part!=="."&&part!==""){results.push(part)}}return results.join("/")};var dirname=function(path){return path.split("/").slice(0,-1).join("/")};var localRequire=function(path){return function(name){var dir=dirname(path);var absolute=expand(dir,name);return globals.require(absolute,path)}};var initModule=function(name,definition){var module={id:name,exports:{}};cache[name]=module;definition(module.exports,localRequire(name),module);return module.exports};var require=function(name,loaderPath){var path=expand(name,".");if(loaderPath==null)loaderPath="/";if(has(cache,path))return cache[path].exports;if(has(modules,path))return initModule(path,modules[path]);var dirIndex=expand(path,"./index");if(has(cache,dirIndex))return cache[dirIndex].exports;if(has(modules,dirIndex))return initModule(dirIndex,modules[dirIndex]);throw new Error('Cannot find module "'+name+'" from '+'"'+loaderPath+'"')};var define=function(bundle,fn){if(typeof bundle==="object"){for(var key in bundle){if(has(bundle,key)){modules[key]=bundle[key]}}}else{modules[bundle]=fn}};var list=function(){var result=[];for(var item in modules){if(has(modules,item)){result.push(item)}}return result};globals.require=require;globals.require.define=define;globals.require.register=define;globals.require.list=list;globals.require.brunch=true})();require.define({phoenix:function(exports,require,module){"use strict";var _prototypeProperties=function(child,staticProps,instanceProps){if(staticProps)Object.defineProperties(child,staticProps);if(instanceProps)Object.defineProperties(child.prototype,instanceProps)};var _classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}};var VSN="1.0.0";var SOCKET_STATES={connecting:0,open:1,closing:2,closed:3};var CHANNEL_STATES={closed:"closed",errored:"errored",joined:"joined",joining:"joining"};var CHANNEL_EVENTS={close:"phx_close",error:"phx_error",join:"phx_join",reply:"phx_reply",leave:"phx_leave"};var TRANSPORTS={longpoll:"longpoll",websocket:"websocket"};var Push=function(){function Push(channel,event,payload){_classCallCheck(this,Push);this.channel=channel;this.event=event;this.payload=payload||{};this.receivedResp=null;this.afterHook=null;this.recHooks=[];this.sent=false}_prototypeProperties(Push,null,{send:{value:function send(){var _this=this;var ref=this.channel.socket.makeRef();this.refEvent=this.channel.replyEventName(ref);this.receivedResp=null;this.sent=false;this.channel.on(this.refEvent,function(payload){_this.receivedResp=payload;_this.matchReceive(payload);_this.cancelRefEvent();_this.cancelAfter()});this.startAfter();this.sent=true;this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:ref})},writable:true,configurable:true},receive:{value:function receive(status,callback){if(this.receivedResp&&this.receivedResp.status===status){callback(this.receivedResp.response)}this.recHooks.push({status:status,callback:callback});return this},writable:true,configurable:true},after:{value:function after(ms,callback){if(this.afterHook){throw"only a single after hook can be applied to a push"}var timer=null;if(this.sent){timer=setTimeout(callback,ms)}this.afterHook={ms:ms,callback:callback,timer:timer};return this},writable:true,configurable:true},matchReceive:{value:function matchReceive(_ref){var status=_ref.status;var response=_ref.response;var ref=_ref.ref;this.recHooks.filter(function(h){return h.status===status}).forEach(function(h){return h.callback(response)})},writable:true,configurable:true},cancelRefEvent:{value:function cancelRefEvent(){this.channel.off(this.refEvent)},writable:true,configurable:true},cancelAfter:{value:function cancelAfter(){if(!this.afterHook){return}clearTimeout(this.afterHook.timer);this.afterHook.timer=null},writable:true,configurable:true},startAfter:{value:function startAfter(){var _this=this;if(!this.afterHook){return}var callback=function(){_this.cancelRefEvent();_this.afterHook.callback()};this.afterHook.timer=setTimeout(callback,this.afterHook.ms)},writable:true,configurable:true}});return Push}();var Channel=exports.Channel=function(){function Channel(topic,params,socket){var _this=this;_classCallCheck(this,Channel);this.state=CHANNEL_STATES.closed;this.topic=topic;this.params=params||{};this.socket=socket;this.bindings=[];this.joinedOnce=false;this.joinPush=new Push(this,CHANNEL_EVENTS.join,this.params);this.pushBuffer=[];this.rejoinTimer=new Timer(function(){return _this.rejoinUntilConnected()},this.socket.reconnectAfterMs);this.joinPush.receive("ok",function(){_this.state=CHANNEL_STATES.joined;_this.rejoinTimer.reset()});this.onClose(function(){_this.socket.log("channel","close "+_this.topic);_this.state=CHANNEL_STATES.closed;_this.socket.remove(_this)});this.onError(function(reason){_this.socket.log("channel","error "+_this.topic,reason);_this.state=CHANNEL_STATES.errored;_this.rejoinTimer.setTimeout()});this.on(CHANNEL_EVENTS.reply,function(payload,ref){_this.trigger(_this.replyEventName(ref),payload)})}_prototypeProperties(Channel,null,{rejoinUntilConnected:{value:function rejoinUntilConnected(){this.rejoinTimer.setTimeout();if(this.socket.isConnected()){this.rejoin()}},writable:true,configurable:true},join:{value:function join(){if(this.joinedOnce){throw"tried to join multiple times. 'join' can only be called a single time per channel instance"}else{this.joinedOnce=true}this.sendJoin();return this.joinPush},writable:true,configurable:true},onClose:{value:function onClose(callback){this.on(CHANNEL_EVENTS.close,callback)},writable:true,configurable:true},onError:{value:function onError(callback){this.on(CHANNEL_EVENTS.error,function(reason){return callback(reason)})},writable:true,configurable:true},on:{value:function on(event,callback){this.bindings.push({event:event,callback:callback})},writable:true,configurable:true},off:{value:function off(event){this.bindings=this.bindings.filter(function(bind){return bind.event!==event})},writable:true,configurable:true},canPush:{value:function canPush(){return this.socket.isConnected()&&this.state===CHANNEL_STATES.joined},writable:true,configurable:true},push:{value:function push(event,payload){if(!this.joinedOnce){throw"tried to push '"+event+"' to '"+this.topic+"' before joining. Use channel.join() before pushing events"}var pushEvent=new Push(this,event,payload);if(this.canPush()){pushEvent.send()}else{this.pushBuffer.push(pushEvent)}return pushEvent},writable:true,configurable:true},leave:{value:function leave(){var _this=this;return this.push(CHANNEL_EVENTS.leave).receive("ok",function(){_this.socket.log("channel","leave "+_this.topic);_this.trigger(CHANNEL_EVENTS.close,"leave")})},writable:true,configurable:true},onMessage:{value:function onMessage(event,payload,ref){},writable:true,configurable:true},isMember:{value:function isMember(topic){return this.topic===topic},writable:true,configurable:true},sendJoin:{value:function sendJoin(){this.state=CHANNEL_STATES.joining;this.joinPush.send()},writable:true,configurable:true},rejoin:{value:function rejoin(){this.sendJoin();this.pushBuffer.forEach(function(pushEvent){return pushEvent.send()});this.pushBuffer=[]},writable:true,configurable:true},trigger:{value:function trigger(triggerEvent,payload,ref){this.onMessage(triggerEvent,payload,ref);this.bindings.filter(function(bind){return bind.event===triggerEvent}).map(function(bind){return bind.callback(payload,ref)})},writable:true,configurable:true},replyEventName:{value:function replyEventName(ref){return"chan_reply_"+ref},writable:true,configurable:true}});return Channel}();var Socket=exports.Socket=function(){function Socket(endPoint){var _this=this;var opts=arguments[1]===undefined?{}:arguments[1];_classCallCheck(this,Socket);this.stateChangeCallbacks={open:[],close:[],error:[],message:[]};this.channels=[];this.sendBuffer=[];this.ref=0;this.transport=opts.transport||window.WebSocket||LongPoll;this.heartbeatIntervalMs=opts.heartbeatIntervalMs||3e4;this.reconnectAfterMs=opts.reconnectAfterMs||function(tries){return[1e3,5e3,1e4][tries-1]||1e4};this.logger=opts.logger||function(){};this.longpollerTimeout=opts.longpollerTimeout||2e4;this.params=opts.params||{};this.endPoint=""+endPoint+"/"+TRANSPORTS.websocket;this.reconnectTimer=new Timer(function(){_this.disconnect(function(){return _this.connect()})},this.reconnectAfterMs)}_prototypeProperties(Socket,null,{protocol:{value:function protocol(){return location.protocol.match(/^https/)?"wss":"ws"},writable:true,configurable:true},endPointURL:{value:function endPointURL(){var uri=Ajax.appendParams(Ajax.appendParams(this.endPoint,this.params),{vsn:VSN});if(uri.charAt(0)!=="/"){return uri}if(uri.charAt(1)==="/"){return""+this.protocol()+":"+uri}return""+this.protocol()+"://"+location.host+""+uri},writable:true,configurable:true},disconnect:{value:function disconnect(callback,code,reason){if(this.conn){this.conn.onclose=function(){};if(code){this.conn.close(code,reason||"")}else{this.conn.close()}this.conn=null}callback&&callback()},writable:true,configurable:true},connect:{value:function connect(params){var _this=this;if(params){console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor");this.params=params}if(this.conn){return}this.conn=new this.transport(this.endPointURL());this.conn.timeout=this.longpollerTimeout;this.conn.onopen=function(){return _this.onConnOpen()};this.conn.onerror=function(error){return _this.onConnError(error)};this.conn.onmessage=function(event){return _this.onConnMessage(event)};this.conn.onclose=function(event){return _this.onConnClose(event)}},writable:true,configurable:true},log:{value:function log(kind,msg,data){this.logger(kind,msg,data)},writable:true,configurable:true},onOpen:{value:function onOpen(callback){this.stateChangeCallbacks.open.push(callback)},writable:true,configurable:true},onClose:{value:function onClose(callback){this.stateChangeCallbacks.close.push(callback)},writable:true,configurable:true},onError:{value:function onError(callback){this.stateChangeCallbacks.error.push(callback)},writable:true,configurable:true},onMessage:{value:function onMessage(callback){this.stateChangeCallbacks.message.push(callback)},writable:true,configurable:true},onConnOpen:{value:function onConnOpen(){var _this=this;this.log("transport","connected to "+this.endPointURL(),this.transport.prototype);this.flushSendBuffer();this.reconnectTimer.reset();if(!this.conn.skipHeartbeat){clearInterval(this.heartbeatTimer);this.heartbeatTimer=setInterval(function(){return _this.sendHeartbeat()},this.heartbeatIntervalMs)}this.stateChangeCallbacks.open.forEach(function(callback){return callback()})},writable:true,configurable:true},onConnClose:{value:function onConnClose(event){this.log("transport","close",event);this.triggerChanError();clearInterval(this.heartbeatTimer);this.reconnectTimer.setTimeout();this.stateChangeCallbacks.close.forEach(function(callback){return callback(event)})},writable:true,configurable:true},onConnError:{value:function onConnError(error){this.log("transport",error);this.triggerChanError();this.stateChangeCallbacks.error.forEach(function(callback){return callback(error)})},writable:true,configurable:true},triggerChanError:{value:function triggerChanError(){this.channels.forEach(function(channel){return channel.trigger(CHANNEL_EVENTS.error)})},writable:true,configurable:true},connectionState:{value:function connectionState(){switch(this.conn&&this.conn.readyState){case SOCKET_STATES.connecting:return"connecting";case SOCKET_STATES.open:return"open";case SOCKET_STATES.closing:return"closing";default:return"closed"}},writable:true,configurable:true},isConnected:{value:function isConnected(){return this.connectionState()==="open"},writable:true,configurable:true},remove:{value:function remove(channel){this.channels=this.channels.filter(function(c){return!c.isMember(channel.topic)})},writable:true,configurable:true},channel:{value:function channel(topic){var chanParams=arguments[1]===undefined?{}:arguments[1];var channel=new Channel(topic,chanParams,this);this.channels.push(channel);return channel},writable:true,configurable:true},push:{value:function push(data){var _this=this;var topic=data.topic;var event=data.event;var payload=data.payload;var ref=data.ref;var callback=function(){return _this.conn.send(JSON.stringify(data))};this.log("push",""+topic+" "+event+" ("+ref+")",payload);if(this.isConnected()){callback()}else{this.sendBuffer.push(callback)}},writable:true,configurable:true},makeRef:{value:function makeRef(){var newRef=this.ref+1;if(newRef===this.ref){this.ref=0}else{this.ref=newRef}return this.ref.toString()},writable:true,configurable:true},sendHeartbeat:{value:function sendHeartbeat(){this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.makeRef()})},writable:true,configurable:true},flushSendBuffer:{value:function flushSendBuffer(){if(this.isConnected()&&this.sendBuffer.length>0){this.sendBuffer.forEach(function(callback){return callback()});this.sendBuffer=[]}},writable:true,configurable:true},onConnMessage:{value:function onConnMessage(rawMessage){var msg=JSON.parse(rawMessage.data);var topic=msg.topic;var event=msg.event;var payload=msg.payload;var ref=msg.ref;this.log("receive",""+(payload.status||"")+" "+topic+" "+event+" "+(ref&&"("+ref+")"||""),payload);this.channels.filter(function(channel){return channel.isMember(topic)}).forEach(function(channel){return channel.trigger(event,payload,ref)});this.stateChangeCallbacks.message.forEach(function(callback){return callback(msg)})},writable:true,configurable:true}});return Socket}();var LongPoll=exports.LongPoll=function(){function LongPoll(endPoint){_classCallCheck(this,LongPoll);this.endPoint=null;this.token=null;this.skipHeartbeat=true;this.onopen=function(){};this.onerror=function(){};this.onmessage=function(){};this.onclose=function(){};this.pollEndpoint=this.normalizeEndpoint(endPoint);this.readyState=SOCKET_STATES.connecting;this.poll()}_prototypeProperties(LongPoll,null,{normalizeEndpoint:{value:function normalizeEndpoint(endPoint){return endPoint.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+TRANSPORTS.websocket),"$1/"+TRANSPORTS.longpoll)},writable:true,configurable:true},endpointURL:{value:function endpointURL(){return Ajax.appendParams(this.pollEndpoint,{token:this.token})},writable:true,configurable:true},closeAndRetry:{value:function closeAndRetry(){this.close();this.readyState=SOCKET_STATES.connecting},writable:true,configurable:true},ontimeout:{value:function ontimeout(){this.onerror("timeout");this.closeAndRetry()},writable:true,configurable:true},poll:{value:function poll(){var _this=this;if(!(this.readyState===SOCKET_STATES.open||this.readyState===SOCKET_STATES.connecting)){return}Ajax.request("GET",this.endpointURL(),"application/json",null,this.timeout,this.ontimeout.bind(this),function(resp){if(resp){var status=resp.status;var token=resp.token;var messages=resp.messages;_this.token=token}else{var status=0}switch(status){case 200:messages.forEach(function(msg){return _this.onmessage({data:JSON.stringify(msg)})});_this.poll();break;case 204:_this.poll();break;case 410:_this.readyState=SOCKET_STATES.open;_this.onopen();_this.poll();break;case 0:case 500:_this.onerror();_this.closeAndRetry();break;default:throw"unhandled poll status "+status}})},writable:true,configurable:true},send:{value:function send(body){var _this=this;Ajax.request("POST",this.endpointURL(),"application/json",body,this.timeout,this.onerror.bind(this,"timeout"),function(resp){if(!resp||resp.status!==200){_this.onerror(status);_this.closeAndRetry()}})},writable:true,configurable:true},close:{value:function close(code,reason){this.readyState=SOCKET_STATES.closed;this.onclose()},writable:true,configurable:true}});return LongPoll}();var Ajax=exports.Ajax=function(){function Ajax(){_classCallCheck(this,Ajax)}_prototypeProperties(Ajax,{request:{value:function request(method,endPoint,accept,body,timeout,ontimeout,callback){if(window.XDomainRequest){var req=new XDomainRequest;this.xdomainRequest(req,method,endPoint,body,timeout,ontimeout,callback)}else{var req=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");this.xhrRequest(req,method,endPoint,accept,body,timeout,ontimeout,callback)}},writable:true,configurable:true},xdomainRequest:{value:function xdomainRequest(req,method,endPoint,body,timeout,ontimeout,callback){var _this=this;req.timeout=timeout;req.open(method,endPoint);req.onload=function(){var response=_this.parseJSON(req.responseText);callback&&callback(response)};if(ontimeout){req.ontimeout=ontimeout}req.onprogress=function(){};req.send(body)},writable:true,configurable:true},xhrRequest:{value:function xhrRequest(req,method,endPoint,accept,body,timeout,ontimeout,callback){var _this=this;req.timeout=timeout;req.open(method,endPoint,true);req.setRequestHeader("Content-Type",accept);req.onerror=function(){callback&&callback(null)};req.onreadystatechange=function(){if(req.readyState===_this.states.complete&&callback){var response=_this.parseJSON(req.responseText);callback(response)}};if(ontimeout){req.ontimeout=ontimeout}req.send(body)},writable:true,configurable:true},parseJSON:{value:function parseJSON(resp){return resp&&resp!==""?JSON.parse(resp):null},writable:true,configurable:true},serialize:{value:function serialize(obj,parentKey){var queryStr=[];for(var key in obj){if(!obj.hasOwnProperty(key)){continue}var paramKey=parentKey?""+parentKey+"["+key+"]":key;var paramVal=obj[key];if(typeof paramVal==="object"){queryStr.push(this.serialize(paramVal,paramKey))}else{queryStr.push(encodeURIComponent(paramKey)+"="+encodeURIComponent(paramVal))}}return queryStr.join("&")},writable:true,configurable:true},appendParams:{value:function appendParams(url,params){if(Object.keys(params).length===0){return url}var prefix=url.match(/\?/)?"&":"?";return""+url+""+prefix+""+this.serialize(params)},writable:true,configurable:true}});return Ajax}();Ajax.states={complete:4};var Timer=function(){function Timer(callback,timerCalc){_classCallCheck(this,Timer);this.callback=callback;this.timerCalc=timerCalc;this.timer=null;this.tries=0}_prototypeProperties(Timer,null,{reset:{value:function reset(){this.tries=0;clearTimeout(this.timer)},writable:true,configurable:true},setTimeout:{value:function(_setTimeout){var _setTimeoutWrapper=function setTimeout(){return _setTimeout.apply(this,arguments)};_setTimeoutWrapper.toString=function(){return _setTimeout.toString()};return _setTimeoutWrapper}(function(){var _this=this;clearTimeout(this.timer);this.timer=setTimeout(function(){_this.tries=_this.tries+1;_this.callback()},this.timerCalc(this.tries+1))}),writable:true,configurable:true}});return Timer}();Object.defineProperty(exports,"__esModule",{value:true})}});if(typeof window==="object"&&!window.Phoenix){window.Phoenix=require("phoenix")}
